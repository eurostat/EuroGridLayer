<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Vector Grid Slicer</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
    <!--script src="https://getbounds.com/apps-plugins/vectorgrid/leaflet-vector-grid-bundled-working.js"></script-->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-omnivore/0.3.4/leaflet-omnivore.min.js"
      integrity="sha256-k1l+ouvMXT+0iRA8pc8e0dge4ZeGjXG6imrvWboFTRE="
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <script>
      // Object to hold our map options
      var parcels,
        id = 0;
      styleOptions = {
        field: "gridcode",
        stops: [100000, 10000, 5000, 1000]
      };
      selectedFeatureId = null;

      var data = omnivore.geojson("10km_pop_grid.geojson");
      data.on("ready", function() {
        parcels = data.toGeoJSON();
        buildMap();
      });

      var options = {
          center: [49.5, 10],
          zoom: 5
        },
        map = L.map("map", options);

      // load map tiles and add to map
      var defaultBase = L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
          subdomains: "abcd",
          maxZoom: 19
        }
      ).addTo(map);

      function buildMap() {
        /* see https://leaflet.github.io/Leaflet.VectorGrid/vectorgrid-api-docs.html */
        var tileLayer = L.vectorGrid
          .slicer(parcels, {
            rendererFactory: L.canvas.tile,
            vectorTileLayerStyles: {
              sliced: function(properties, zoom) {
                //class-break styling for population grid
                let style = {
                  fillOpacity: 1,
                  fill: true,
                  weight: 0
                };

                var value = properties[styleOptions.field];
                if (value > styleOptions.stops[0]) {
                  style.fillColor = "red";
                } else if (
                  value < styleOptions.stops[0] &&
                  value > styleOptions.stops[1]
                ) {
                  style.fillColor = "#ffce08";
                } else if (
                  value < styleOptions.stops[1] &&
                  value > styleOptions.stops[2]
                ) {
                  style.fillColor = "#ebff0a";
                } else if (
                  value < styleOptions.stops[2] &&
                  value > styleOptions.stops[3]
                ) {
                  style.fillColor = "#55e238";
                } else if (value < styleOptions.stops[3] && value > 0) {
                  style.fillColor = "#005cff";
                } else {
                  style.fillColor = "#000";
                }

                return style;
              }
            },
            maxZoom: 22,
            indexMaxZoom: 5, // max zoom in the initial tile index
            interactive: true,
            getFeatureId: function(feature) {
              id = id + 1;
              feature.properties.id = id;
              return id;
            }
          })
          .addTo(map);

        tileLayer.on("click", e => {
          let featureid;
          if (e.layer.feature) {
            var prop = e.layer.feature.properties;
            featureid = e.layer.feature.properties.id;
          } else {
            var prop = e.layer.properties;
            featureid = e.layer.properties.id;
          }
          //open popup;
          layerPopup = L.popup()
            .setLatLng(e.latlng)
            .setContent("Population: " + e.layer.properties.gridcode)
            .openOn(map);

          //highlight cell
          selectedFeatureId = featureid;
          tileLayer.setFeatureStyle(featureid, {
            color: "aqua",
            weight: 2
          });
        });

        tileLayer.on("mouseout", e => {
          tileLayer.resetFeatureStyle(selectedFeatureId);
          //open popup;
          map.closePopup(layerPopup);
        });

        /* Need to add something to change the style back once another parcel is clicked*/
      }

      function uuidv4() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(
          c
        ) {
          var r = (Math.random() * 16) | 0,
            v = c == "x" ? r : (r & 0x3) | 0x8;
          return v.toString(16);
        });
      }
    </script>
  </body>
</html>
