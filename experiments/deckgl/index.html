<html>

<head>
  <title>deck.gl PointCloudLayer Example</title>

  <script src="https://unpkg.com/deck.gl@^7.0.0/dist.min.js"></script>

  <style type="text/css">
    body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      background: #000;
    }
  </style>
</head>

<body></body>

<script type="text/javascript">

  const { DeckGL, PointCloudLayer, COORDINATE_SYSTEM } = deck;

  // One million points
  const SAMPLE_SIZE = 2e6;
  const SURFACE_EQUATION = (x, y) => Math.sin(x * x + y * y) * x / Math.PI;
  const EPSILON = 1e-4;

  const points = [];
  const dim = Math.sqrt(SAMPLE_SIZE);

  function getPosition(u, v) {
    const x = (u - 1 / 2) * Math.PI * 2;
    const y = (v - 1 / 2) * Math.PI * 2;
    const z = SURFACE_EQUATION(x, y);

    return [x, y, z];
  }

  function getNormal(u, v) {
    const p0 = getPosition(u - EPSILON, v - EPSILON);
    const p1 = getPosition(u + EPSILON, v + EPSILON);

    const nx = (p1[1] - p0[1]) * (p1[2] - p0[2]);
    const ny = (p1[2] - p0[2]) * (p1[0] - p0[0]);
    const nz = (p1[0] - p0[0]) * (p1[1] - p0[1]);

    return [nx, ny, nz];
  }
  //random points
  /* 
    for (let i = 0; i < dim; i++) {
      for (let j = 0; j < dim; j++) {
        const u = i / (dim - 1);
        const v = j / (dim - 1);
  
        const p = getPosition(u, v);
        const n = getNormal(u, v);
        points.push({
          position: p,
          normal: n,
          color: [u * 128, v * 128, p[2] * 255]
        });
      }
    } */



  this.getCSV("../assets/csv/pop_1km_new.csv", data => {
    var csvArray = parseCSV(data);
    for (var i = 1; i < csvArray.length; i++) {
      let cell = csvArray[i];
      var x = (parseInt(cell[1]) / 100);
      var y = -Math.abs((parseInt(cell[0]) / 100));
      var z = 0;

      points.push({
        position: [x, y, z],
        normal: [0, 0, 1],
        color: valueToColor(parseInt(cell[2]))
      });
    }
    new DeckGL({
      views: [new OrthographicView()],
      viewState: { target: [40, -33, 0], zoom: 5 },
      layers: [
        /*         new PointCloudLayer({
                  id: 'pointCloud',
                  coordinateSystem: COORDINATE_SYSTEM.IDENTITY,
                  opacity: 1,
                  data: points,
                  getPosition: d => d.position,
                  getNormal: d => d.normal,
                  getColor: d => d.color,
                  pointSize: 0.5
                }) */
        new ScatterplotLayer({
          id: 'scatter-plot',
          data: points,
          radiusScale: 10,
          radiusMinPixels: 0.5,
          getPosition: d => [d.position[0], d.position[1]],
          getFillColor: d => d.color
        })
      ]
    });
  });



  function getCSV(url, callback) {
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function () {
      if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
        try {
          var data = xmlhttp.responseText;
        } catch (err) {
          console.log(err.message + " in " + xmlhttp.responseText);
          return;
        }
        callback(data);
      }
    };
    xmlhttp.open("GET", url, true);
    xmlhttp.send();
  };

  function parseCSV(str) {
    var arr = [];
    var quote = false; // true means we're inside a quoted field

    // iterate over each character, keep track of current row and column (of the returned array)
    for (var row = 0, col = 0, c = 0; c < str.length; c++) {
      var cc = str[c],
        nc = str[c + 1]; // current character, next character
      arr[row] = arr[row] || []; // create a new row if necessary
      arr[row][col] = arr[row][col] || ""; // create a new column (start with empty string) if necessary

      // If the current character is a quotation mark, and we're inside a
      // quoted field, and the next character is also a quotation mark,
      // add a quotation mark to the current column and skip the next character
      if (cc == '"' && quote && nc == '"') {
        arr[row][col] += cc;
        ++c;
        continue;
      }

      // If it's just one quotation mark, begin/end quoted field
      if (cc == '"') {
        quote = !quote;
        continue;
      }

      // If it's a comma and we're not in a quoted field, move on to the next column
      if (cc == "," || (cc == ";" && !quote)) {
        ++col;
        continue;
      }

      // If it's a newline (CRLF) and we're not in a quoted field, skip the next character
      // and move on to the next row and move to column 0 of that new row
      if (cc == "\r" && nc == "\n" && !quote) {
        ++row;
        col = 0;
        ++c;
        continue;
      }

      // If it's a newline (LF or CR) and we're not in a quoted field,
      // move on to the next row and move to column 0 of that new row
      if (cc == "\n" && !quote) {
        ++row;
        col = 0;
        continue;
      }
      if (cc == "\r" && !quote) {
        ++row;
        col = 0;
        continue;
      }

      // Otherwise, append the current character to the current column
      arr[row][col] += cc;
    }
    return arr;
  };


  function valueToColor(value) {
    if (value > 10000) {
      return [15, 240, 240]; //red
    } else if (value > 5000) {
      return [15, 252, 224]; //orange
    } else if (value > 1000) {
      return [14, 191, 240]; //yellow
    } else if (value > 100) {
      return [5, 94, 35]; //green
    } else if (value > 0) {
      return [0, 5, 207]; //blue
    }
    /*         var value = value / 1400000;
            value = Math.pow(value, 0.2);
            //see https://github.com/d3/d3-scale-chromatic
            // https://npmdoc.github.io/node-npmdoc-d3-scale/build/apidoc.html
            let rgb = d3.interpolateTurbo(value);
            return rgb; */
  };


</script>

</html>