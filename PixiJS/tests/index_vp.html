<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Test</title>
  </head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.5/pixi.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pixi-viewport@4.3.3/dist/viewport.min.js"></script>

  <body>
    <script type="text/javascript">
      //see doc: http://pixijs.download/release/docs/index.html
      //https://github.com/davidfig/pixi-viewport
      //https://davidfig.github.io/pixi-viewport/jsdoc/

      //create a fake dataset of random cells.
      //coordinate of grid origin is 1000'000,5000'000
      //TODO use tile coordinates + in draw also
      //TODO load and show few of the real tiles 
      const nb = 20;
      const tileSize = 32;
      const resolution = 10000;
      const origin = {x:1000000, y:5000000};

      //TODO load real dataset, 10km resolution
      console.log("Build fake dataset...");
      var tiles = [];
      for (var i = 0; i < nb; i++)
        for (var j = 0; j < nb; j++) {
          var tile = { x: i, y: j, cells: [] };
          tiles.push(tile);
          for (var x = 0; x < tileSize; x++)
            for (var y = 0; y < tileSize; y++)
              tile.cells.push( { x: x, y: y, val: i + j + 100 * Math.random() } );
        }

      console.log("Build application...");

      //value to color
      var valueToColor = function(value) {
        if (value > 90) return 0xff0f00; //red
        if (value > 80) return 0xffce08; //orange
        if (value > 60) return 0xebff0a; //yellow
        if (value > 40) return 0x55e238; //green
        return 0x005cff; //blue
      };

      let type = "WebGL";
      if (!PIXI.utils.isWebGLSupported()) type = "canvas";

      //create application and add it to page
      let app = new PIXI.Application({
        width: 1200,
        height: 500,
        antialias: true
      });
      document.body.appendChild(app.view);

      app.renderer.backgroundColor = 0x061639;

      // create viewport
      const viewport = new Viewport.Viewport({
        screenWidth: 1200,
        screenHeight: 500,
        worldWidth: 2000000,
        worldHeight: 6000000, //TODO use top/bottom/right/left instead ?
        interaction: app.renderer.plugins.interaction
      });

      // add the viewport to the stage
      app.stage.addChild(viewport);

      // activate plugins
      viewport
        .drag()
        .pinch()
        .wheel()
        .decelerate();

      console.log("Draw...");




      drawTile = function(tile) {
        let gr = new PIXI.Graphics();
        for (var j = 0; j < tile.cells.length; j++) {
          var cell = tile.cells[j];
          //draw cell
          gr.x = origin.x + tile.x * tileSize * resolution;
          gr.y = origin.y + tile.y * tileSize * resolution;
          //TODO fix that:
          //gr.scale = resolution;
          gr.beginFill(valueToColor(cell.val));
          gr.drawRect(
            resolution * cell.x,
            resolution * cell.y,
            resolution,
            resolution
          );
          gr.endFill();
        }
        viewport.addChild(gr);
      };

      //draw tiles
      for (var i = 0; i < tiles.length; i++) {
        var tile = tiles[i];
        drawTile(tile);
      }





      //interpretation of scaled factor:
      //pixelSizeM = 1/scaled
      //a grid cell is represented as a single pixel when scaled = 1/resolution
      //viewport.scaled = 0.0001;
      viewport.setZoom(0.0001, true);
      viewport.moveCenter(1500000, 5500000);
      //console.log(viewport.scaled);


      viewport.on("wheel", e => {
        console.log(e);
        //TODO
      });

      viewport.on("clicked", e => {
        console.log(e.world);
        //TODO show stat value
      });
      //TODO no event for mouse move ?

      //console.log(viewport.toScreen(1500000, 5500000));
      //console.log(viewport.toWorld(600, 250));
      //OK

      //console.log(viewport.getVisibleBounds());
      //use that to find the tiles to load and show
      //use that to load tiles:
      //load an image and run the `setup` function when it's done
      //PIXI.loader
      //    .add("images/cat.png")
      //    .load(setup);

      //TODO find a way to invert y axis... but how?
    </script>
  </body>
</html>
